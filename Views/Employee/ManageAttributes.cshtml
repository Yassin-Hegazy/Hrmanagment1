@model HRMANGMANGMENT.Models.Employee

@{
    ViewData["Title"] = "Manage Employee Attributes";
    var departments = ViewBag.Departments as IEnumerable<HRMANGMANGMENT.Models.Department>;
    var contracts = ViewBag.Contracts as IEnumerable<HRMANGMANGMENT.Models.Contract>;
}

<div class="container-fluid mt-4 animate-fade-in">
    <div class="page-header stagger-animation">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2><i class="bi bi-sliders"></i> Manage Attributes</h2>
                <p class="mb-0 opacity-75">Directly edit profile fields for <strong>@Model.FirstName @Model.LastName</strong></p>
            </div>
            <div class="col-md-6 text-end">
                <a asp-action="Details" asp-route-id="@Model.EmployeeId" class="btn btn-secondary hover-lift">
                    <i class="bi bi-arrow-left"></i> Back to Profile
                </a>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card glass-card hover-lift stagger-animation">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 25%;">Attribute</th>
                            <th style="width: 50%;">Current Value</th>
                            <th style="width: 25%;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* Helper to render row *@
                        @{
                            async Task RenderRow(string label, string fieldName, object value, string inputType = "text", IEnumerable<SelectListItem> options = null)
                            {
                                var displayValue = value?.ToString() ?? "N/A";
                                var collapseId = "collapse-" + fieldName;
                                
                                <tr>
                                    <td class="fw-bold text-secondary">@label</td>
                                    <td>
                                        <span class="text-dark">@displayValue</span>
                                        <div class="collapse mt-2" id="@collapseId">
                                            <form asp-action="UpdateAttribute" method="post" class="d-flex gap-2">
                                                <input type="hidden" name="employeeId" value="@Model.EmployeeId" />
                                                <input type="hidden" name="fieldName" value="@fieldName" />
                                                
                                                @if (options != null)
                                                {
                                                    <select name="newValue" class="form-select form-select-sm">
                                                        @foreach (var opt in options)
                                                        {
                                                            <!option value="@opt.Value" @(opt.Value == value?.ToString() ? "selected" : "")>@opt.Text</!option>
                                                        }
                                                    </select>
                                                }
                                                else if (inputType == "textarea") 
                                                {
                                                    <textarea name="newValue" class="form-control form-control-sm" rows="1">@value</textarea>
                                                }
                                                else
                                                {
                                                    <input type="@inputType" name="newValue" class="form-control form-control-sm" value="@value" />
                                                }
                                                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                            </form>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                            }
                        }

                        <!-- Basic Information -->
                        <tr class="bg-light"><td colspan="3" class="fw-bold text-uppercase small text-muted ps-3">Basic Information</td></tr>
                        @{ await RenderRow("First Name", "first_name", Model.FirstName); }
                        @{ await RenderRow("Last Name", "last_name", Model.LastName); }
                        @{ await RenderRow("National ID", "national_id", Model.NationalId); }
                        @{ await RenderRow("Country of Birth", "country_of_birth", Model.CountryOfBirth); }
                        @{ await RenderRow("Date of Birth", "date_of_birth", Model.DateOfBirth?.ToString("yyyy-MM-dd") ?? "", "date"); }
                        @{ await RenderRow("Phone", "phone", Model.Phone); }
                        @{ await RenderRow("Email", "email", Model.Email, "email"); }
                        @{ await RenderRow("Address", "address", Model.Address); }
                        @{ await RenderRow("Biography", "biography", Model.Biography, "textarea"); }

                        <!-- Emergency Contact -->
                        <tr class="bg-light"><td colspan="3" class="fw-bold text-uppercase small text-muted ps-3">Emergency Contact</td></tr>
                        @{ await RenderRow("Contact Name", "emergency_contact_name", Model.EmergencyContactName); }
                        @{ await RenderRow("Contact Phone", "emergency_contact_phone", Model.EmergencyContactPhone); }
                        @{ await RenderRow("Relationship", "relationship", Model.Relationship); }

                        <!-- Employment Status -->
                        <tr class="bg-light"><td colspan="3" class="fw-bold text-uppercase small text-muted ps-3">Employment Details</td></tr>
                        @{ await RenderRow("Employment Status", "employment_status", Model.EmploymentStatus); }
                        @{ await RenderRow("Progress", "employment_progress", Model.EmploymentProgress); }
                        @{ await RenderRow("Account Status", "account_status", Model.AccountStatus); }
                        @{ await RenderRow("Hire Date", "hire_date", Model.HireDate?.ToString("yyyy-MM-dd") ?? "", "date"); }
                        @{ await RenderRow("Is Active", "is_active", Model.IsActive ? "1" : "0"); } 
                        @{ await RenderRow("Pay Grade", "pay_grade", Model.PayGrade); }
                        @{ await RenderRow("Completion %", "profile_completion", Model.ProfileCompletion); }

                        <!-- IDs and Links -->
                        <tr class="bg-light"><td colspan="3" class="fw-bold text-uppercase small text-muted ps-3">System Links</td></tr>
                        
                        @{
                            var deptOptions = departments?.Select(d => new SelectListItem { Value = d.DepartmentId.ToString(), Text = d.DepartmentName });
                            await RenderRow("Department ID", "department_id", Model.DepartmentId, "number", deptOptions);
                        }
                        
                        @{ await RenderRow("Position ID", "position_id", Model.PositionId, "number"); }
                        @{ await RenderRow("Manager ID", "manager_id", Model.ManagerId, "number"); }
                        
                        @{
                             var contractOptions = contracts?.Select(c => new SelectListItem { Value = c.ContractId.ToString(), Text = $"#{c.ContractId} - {c.ContractType}" });
                             await RenderRow("Contract ID", "contract_id", Model.ContractId, "number", contractOptions);
                        }
                        
                        @{ await RenderRow("Tax Form ID", "tax_form_id", Model.TaxFormId, "number"); }
                        @{ await RenderRow("Profile Image (Path)", "profile_image", Model.ProfileImage); }

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
